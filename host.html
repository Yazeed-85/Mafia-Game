<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§ - Ø§Ù„Ù‡ÙˆØ³Øª</title>
    <style>
        body { font-family: sans-serif; background-color: #111; color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .header { text-align: center; margin-bottom: 20px; }
        .pin-display { font-size: 3rem; font-weight: bold; color: #dc2626; letter-spacing: 5px; background: rgba(0,0,0,0.5); padding: 10px 40px; border-radius: 10px; border: 2px dashed #dc2626; margin: 10px 0;}
        
        .panel { background: #222; width: 100%; max-width: 600px; padding: 20px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; box-sizing: border-box;}
        h2 { color: #aaa; margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid #444; padding-bottom: 10px;}
        
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 1.1rem;}
        select { padding: 8px; font-size: 1rem; border-radius: 5px; background: #333; color: white; border: 1px solid #555; width: 180px;}
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .players-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .player-badge { background: #333; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; border-right: 4px solid #4b5563;}
        .player-badge.is-host { border-color: #dc2626; }

        .btn-start { background: #dc2626; color: white; border: none; padding: 15px; font-size: 1.3rem; font-weight: bold; border-radius: 10px; cursor: pointer; width: 100%; transition: 0.2s;}
        .btn-start:active { transform: scale(0.95); }
        .btn-reshuffle { background: #b45309; margin-top: 15px;}
        
        #roleDisplay { display: none; font-size: 1.5rem; font-weight: bold; text-align: center; margin-top: 20px; padding: 20px; border-radius: 10px;}
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y",
            authDomain: "buttons-f3501.firebaseapp.com",
            databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com",
            projectId: "buttons-f3501"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        const myName = urlParams.get('name');
        const myId = "host_" + Date.now();

        document.getElementById('pinDisplay').innerText = pin;
        
        const roomRef = ref(db, `mafia_rooms/${pin}`);
        const playersRef = ref(db, `mafia_rooms/${pin}/players`);
        const settingsRef = ref(db, `mafia_rooms/${pin}/settings`);

        set(roomRef, { settings: { status: 'waiting', timestamp: Date.now() } });
        set(ref(db, `mafia_rooms/${pin}/players/${myId}`), { name: myName, role: '', isHost: true });
        onDisconnect(roomRef).remove(); 

        let playersData = {};

        onValue(playersRef, (snapshot) => {
            if (snapshot.exists()) {
                playersData = snapshot.val();
                renderPlayers();
                updateJudgeSelect();
            }
        });

        onValue(settingsRef, (snapshot) => {
            if (snapshot.exists()) {
                const settings = snapshot.val();
                if (settings.status === 'distributed' && playersData[myId]) {
                    showMyRole(playersData[myId].role);
                } else {
                    document.getElementById('roleDisplay').style.display = 'none';
                }
            }
        });

        function renderPlayers() {
            const list = document.getElementById('playersList');
            const count = document.getElementById('playerCount');
            list.innerHTML = '';
            
            const pKeys = Object.keys(playersData);
            count.innerText = pKeys.length;

            pKeys.forEach(key => {
                const p = playersData[key];
                list.innerHTML += `<div class="player-badge ${p.isHost ? 'is-host' : ''}">${p.name}</div>`;
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        function updateJudgeSelect() {
            const judgeSelect = document.getElementById('judgeSelect');
            const currentValue = judgeSelect.value;
            judgeSelect.innerHTML = '';
            
            Object.keys(playersData).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.text = playersData[key].name + (key === myId ? " (Ø£Ù†Ø§)" : "");
                judgeSelect.appendChild(option);
            });
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
            if (playersData[currentValue]) judgeSelect.value = currentValue;
        }

        window.distributeRoles = async function(isReshuffle = false) {
            if (isReshuffle && !confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø®Ù„Ø· ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ")) return;

            const pKeys = Object.keys(playersData);
            const judgeId = document.getElementById('judgeSelect').value;
            const numMafia = parseInt(document.getElementById('mafiaCount').value);

            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¹Ø¨
            if (pKeys.length < 4) {
                alert("Ø§Ù„Ù„Ø¹Ø¨Ø© ØªØ­ØªØ§Ø¬ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…ØªØ¹Ø© (Ø¨Ù…Ù† ÙÙŠÙ‡Ù… Ø§Ù„Ù‚Ø§Ø¶ÙŠ)!");
                return;
            }

            let playersToAssign = [];
            let updates = {};

            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ø£ÙˆÙ„Ø§Ù‹
            pKeys.forEach(key => {
                if (key === judgeId) {
                    updates[`mafia_rooms/${pin}/players/${key}/role`] = 'Ø§Ù„Ù‚Ø§Ø¶ÙŠ';
                } else {
                    playersToAssign.push(key);
                }
            });

            // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙƒØ§ÙÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¶ÙŠ
            const minimumRequired = numMafia + 2; // (Ù…Ø§ÙÙŠØ§ + Ø¯ÙƒØªÙˆØ± + Ù…Ø­Ù‚Ù‚) ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰
            if (playersToAssign.length < minimumRequired) {
                alert(`ØªØ­ØªØ§Ø¬ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ${minimumRequired + 1} Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø¨Ù…Ø§ ÙÙŠÙ‡Ù… Ø§Ù„Ù‚Ø§Ø¶ÙŠ) Ù„ØªÙˆØ²ÙŠØ¹ ${numMafia} Ù…Ø§ÙÙŠØ§ ÙˆØ¯ÙƒØªÙˆØ± ÙˆÙ…Ø­Ù‚Ù‚!`);
                return;
            }

            // ØªØ¬Ù‡ÙŠØ² ÙƒØ±ÙˆØª Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù„Ù„ÙˆØ±Ù‚ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            let rolesPool = [];
            for(let i=0; i<numMafia; i++) rolesPool.push("Ù…Ø§ÙÙŠØ§");
            rolesPool.push("Ø¯ÙƒØªÙˆØ±");
            rolesPool.push("Ù…Ø­Ù‚Ù‚");
            
            // Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù…ÙˆØ§Ø·Ù†ÙŠÙ†
            while(rolesPool.length < playersToAssign.length) {
                rolesPool.push("Ù…ÙˆØ§Ø·Ù†");
            }

            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø®Ù„Ø· Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            rolesPool.sort(() => Math.random() - 0.5);
            rolesPool.sort(() => Math.random() - 0.5); 

            // Ø±Ø¨Ø· Ø§Ù„ÙƒØ±ÙˆØª Ø¨Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            playersToAssign.forEach((playerKey, index) => {
                updates[`mafia_rooms/${pin}/players/${playerKey}/role`] = rolesPool[index];
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            updates[`mafia_rooms/${pin}/settings/status`] = "distributed";
            updates[`mafia_rooms/${pin}/settings/timestamp`] = Date.now(); 
            updates[`mafia_rooms/${pin}/settings/judgeName`] = playersData[judgeId].name; // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹

            await update(ref(db), updates);
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('reshuffleBtn').style.display = 'block';
        };

        function showMyRole(role) {
            const display = document.getElementById('roleDisplay');
            display.style.display = 'block';
            display.innerText = `Ø£Ù†Øª: ${role}`;
            
            if(role === 'Ù…Ø§ÙÙŠØ§') { display.style.background = '#7f1d1d'; display.style.color = '#fca5a5'; }
            else if(role === 'Ø¯ÙƒØªÙˆØ±') { display.style.background = '#14532d'; display.style.color = '#86efac'; }
            else if(role === 'Ù…Ø­Ù‚Ù‚') { display.style.background = '#1e3a8a'; display.style.color = '#93c5fd'; }
            else if(role === 'Ø§Ù„Ù‚Ø§Ø¶ÙŠ') { display.style.background = '#78350f'; display.style.color = '#fde68a'; }
            else { display.style.background = '#374151'; display.style.color = '#d1d5db'; } 
        }
    </script>
</head>
<body>
    <div class="header">
        <div style="color: #888;">Ø£Ø®Ø¨Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯</div>
        <div class="pin-display" id="pinDisplay">----</div>
    </div>

    <div class="panel">
        <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
        <div class="setting-row">
            <span>Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù‚Ø§Ø¶ÙŠØŸ</span>
            <select id="judgeSelect"></select>
        </div>
        <div class="setting-row">
            <span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§:</span>
            <select id="mafiaCount">
                <option value="1">1 Ù…Ø§ÙÙŠØ§</option>
                <option value="2">2 Ù…Ø§ÙÙŠØ§</option>
            </select>
        </div>
    </div>

    <div class="panel">
        <h2>ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†Ø¶Ù…ÙŠÙ† (<span id="playerCount">0</span>)</h2>
        <div class="players-list" id="playersList"></div>
    </div>

    <button id="startBtn" class="btn-start" onclick="distributeRoles(false)">ğŸ² ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
    <button id="reshuffleBtn" class="btn-start btn-reshuffle" style="display:none;" onclick="distributeRoles(true)">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø®Ù„Ø· ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹</button>

    <div id="roleDisplay"></div>
</body>
</html>
