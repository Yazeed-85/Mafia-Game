<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§ - Ø§Ù„Ù‡ÙˆØ³Øª</title>
    <style>
        body { font-family: sans-serif; background-color: #111; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; padding-top: 20px;}
        
        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ù„ÙˆØ¨ÙŠ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª --- */
        #setupScreen { width: 100%; display: flex; flex-direction: column; align-items: center; padding: 0 20px; box-sizing: border-box; }
        .header { text-align: center; margin-bottom: 20px; }
        .pin-display { font-size: 3rem; font-weight: bold; color: #dc2626; letter-spacing: 5px; background: rgba(0,0,0,0.5); padding: 10px 40px; border-radius: 10px; border: 2px dashed #dc2626; margin: 10px 0;}
        
        .panel { background: #222; width: 100%; max-width: 600px; padding: 20px; border-radius: 10px; border: 1px solid #444; margin-bottom: 20px; box-sizing: border-box;}
        h2 { color: #aaa; margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid #444; padding-bottom: 10px;}
        
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 1.1rem;}
        select { padding: 8px; font-size: 1rem; border-radius: 5px; background: #333; color: white; border: 1px solid #555; width: 180px; outline: none;}
        
        .players-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .player-badge { background: #333; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; border-right: 4px solid #4b5563;}
        .player-badge.is-host { border-color: #dc2626; }

        .btn-start { background: #dc2626; color: white; border: none; padding: 15px; font-size: 1.3rem; font-weight: bold; border-radius: 10px; cursor: pointer; width: 100%; max-width: 600px; transition: 0.2s; box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);}
        .btn-start:active { transform: scale(0.95); }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¹Ø§Ù…Ø© --- */
        #gameScreen { display: none; width: 100%; flex-direction: column; align-items: center; }
        .judge-banner { background: #78350f; color: #fde68a; width: 100%; padding: 15px; text-align: center; font-weight: bold; font-size: 1.2rem; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);}
        .instruction { color: #888; margin-bottom: 20px; font-size: 1.1rem; text-align: center;}

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø§Ø¶ÙŠ (Ù…Ø±Ø¨Ø¹ ÙƒØ¨ÙŠØ± Ø«Ø§Ø¨Øª) --- */
        #judgeView { display: none; width: 90%; max-width: 400px; background: #451a03; border: 4px solid #f59e0b; border-radius: 20px; padding: 40px 20px; text-align: center; box-shadow: 0 0 30px rgba(245, 158, 11, 0.2); margin-top: 20px; }
        .judge-title { font-size: 2.5rem; font-weight: 900; color: #fcd34d; margin-bottom: 10px; }
        .judge-desc { color: #fde68a; font-size: 1.2rem; line-height: 1.6; }

        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ (Ù„Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø³Ø±ÙŠØ©) --- */
        #cardContainer { display: none; width: 250px; height: 350px; perspective: 1000px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
        .card-inner.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 15px 35px rgba(0,0,0,0.6); border: 2px solid #333; }
        /* Ø¸Ù‡Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ Ù„Ø¹Ø¯Ù… ÙƒØ´Ù Ø§Ù„Ø¶ÙˆØ¡ */
        .card-front { background: repeating-linear-gradient(45deg, #1f2937, #1f2937 10px, #252f3e 10px, #252f3e 20px); color: #6b7280; font-size: 5rem; font-weight: bold; }
        .card-back { background: #222; transform: rotateY(180deg); padding: 20px; box-sizing: border-box; }
        
        .role-title { font-size: 3rem; font-weight: 900; margin: 10px 0; text-shadow: 2px 2px 5px rgba(0,0,0,0.5);}
        .role-desc { font-size: 1.1rem; color: #fff; margin-top: 10px;}

        .btn-end { background: transparent; border: 2px solid #555; color: #aaa; padding: 12px 30px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 40px; transition: 0.2s;}
        .btn-end:hover { background: #333; color: #fff; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5CobIKfYdAz8jaabJpMQrGoqS9Ton28Y",
            authDomain: "buttons-f3501.firebaseapp.com",
            databaseURL: "https://buttons-f3501-default-rtdb.firebaseio.com",
            projectId: "buttons-f3501"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const pin = urlParams.get('pin');
        const myName = urlParams.get('name');
        const myId = "host_" + Date.now();

        document.getElementById('pinDisplay').innerText = pin;
        
        const roomRef = ref(db, `mafia_rooms/${pin}`);
        const playersRef = ref(db, `mafia_rooms/${pin}/players`);
        const settingsRef = ref(db, `mafia_rooms/${pin}/settings`);

        set(roomRef, { settings: { status: 'waiting', timestamp: Date.now(), judgeName: '' } });
        set(ref(db, `mafia_rooms/${pin}/players/${myId}`), { name: myName, role: '', isHost: true });
        onDisconnect(roomRef).remove(); 

        let playersData = {};

        onValue(playersRef, (snapshot) => {
            if (snapshot.exists()) {
                playersData = snapshot.val();
                renderPlayers();
                updateJudgeSelect();
            }
        });

        onValue(settingsRef, (snapshot) => {
            if (snapshot.exists()) {
                const settings = snapshot.val();
                if (settings.status === 'distributed' && playersData[myId]) {
                    document.getElementById('setupScreen').style.display = 'none';
                    document.getElementById('gameScreen').style.display = 'flex';
                    document.getElementById('judgeName').innerText = settings.judgeName;
                    setupRoleView(playersData[myId].role);
                } else {
                    document.getElementById('setupScreen').style.display = 'flex';
                    document.getElementById('gameScreen').style.display = 'none';
                }
            }
        });

        function renderPlayers() {
            const list = document.getElementById('playersList');
            const count = document.getElementById('playerCount');
            list.innerHTML = '';
            const pKeys = Object.keys(playersData);
            count.innerText = pKeys.length;

            pKeys.forEach(key => {
                const p = playersData[key];
                list.innerHTML += `<div class="player-badge ${p.isHost ? 'is-host' : ''}">${p.name}</div>`;
            });
        }

        function updateJudgeSelect() {
            const judgeSelect = document.getElementById('judgeSelect');
            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ÙˆØ¥Ù„Ø§ ÙØ§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‡Ùˆ "random"
            const currentValue = judgeSelect.value;
            
            judgeSelect.innerHTML = '<option value="random">ğŸ² Ø¹Ø´ÙˆØ§Ø¦ÙŠ (ÙŠÙÙˆØ²Ø¹ Ø³Ø±ÙŠØ§Ù‹)</option>';
            
            Object.keys(playersData).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.text = playersData[key].name + (key === myId ? " (Ø£Ù†Ø§)" : "");
                judgeSelect.appendChild(option);
            });
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø§ Ø²Ø§Ù„Øª ØµØ§Ù„Ø­Ø©
            if (currentValue && (currentValue === 'random' || playersData[currentValue])) {
                judgeSelect.value = currentValue;
            }
        }

        window.distributeRoles = async function() {
            const pKeys = Object.keys(playersData);
            let judgeId = document.getElementById('judgeSelect').value;
            const numMafia = parseInt(document.getElementById('mafiaCount').value);

            // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠØŒ Ù†Ø®ØªØ§Ø± ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¢Ù†
            if (judgeId === 'random') {
                judgeId = pKeys[Math.floor(Math.random() * pKeys.length)];
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¯Ø¯
            const minPlayers = numMafia + 3; // Ù‚Ø§Ø¶ÙŠ + Ù…Ø§ÙÙŠØ§ + Ø¯ÙƒØªÙˆØ± + Ù…Ø­Ù‚Ù‚
            if (pKeys.length < minPlayers) {
                alert(`Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù‚Ù„ÙŠÙ„! ØªØ­ØªØ§Ø¬ ${minPlayers} Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø¶ÙŠ) Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.`);
                return;
            }

            let playersToAssign = [];
            let rolesPool = [];
            let updates = {};
            let finalJudgeName = playersData[judgeId].name;

            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¶ÙŠ
            updates[`mafia_rooms/${pin}/players/${judgeId}/role`] = 'Ø§Ù„Ù‚Ø§Ø¶ÙŠ';

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù‚ÙŠØ© Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø³Ø±ÙŠØ©
            pKeys.forEach(key => { if (key !== judgeId) playersToAssign.push(key); });

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒØ±ÙˆØª
            for(let i=0; i<numMafia; i++) rolesPool.push("Ù…Ø§ÙÙŠØ§");
            rolesPool.push("Ø¯ÙƒØªÙˆØ±");
            rolesPool.push("Ù…Ø­Ù‚Ù‚");
            while(rolesPool.length < playersToAssign.length) rolesPool.push("Ù…ÙˆØ§Ø·Ù†");

            // Ø®Ù„Ø·
            rolesPool.sort(() => Math.random() - 0.5);
            rolesPool.sort(() => Math.random() - 0.5); 

            // ØªÙˆØ²ÙŠØ¹
            playersToAssign.forEach((playerKey, index) => {
                updates[`mafia_rooms/${pin}/players/${playerKey}/role`] = rolesPool[index];
            });

            // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
            updates[`mafia_rooms/${pin}/settings/status`] = "distributed";
            updates[`mafia_rooms/${pin}/settings/timestamp`] = Date.now(); 
            updates[`mafia_rooms/${pin}/settings/judgeName`] = finalJudgeName; 

            await update(ref(db), updates);
        };

        window.endRound = async function() {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù„Ù„ÙˆØ¨ÙŠØŸ")) {
                await update(ref(db, `mafia_rooms/${pin}/settings`), {
                    status: 'waiting',
                    timestamp: Date.now()
                });
            }
        };

        function setupRoleView(role) {
            const judgeView = document.getElementById('judgeView');
            const cardContainer = document.getElementById('cardContainer');
            const instructions = document.getElementById('instructionText');

            if (role === 'Ø§Ù„Ù‚Ø§Ø¶ÙŠ') {
                // Ø§Ù„Ù‚Ø§Ø¶ÙŠ: Ø´Ø§Ø´Ø© Ù…ÙƒØ´ÙˆÙØ©
                cardContainer.style.display = 'none';
                instructions.style.display = 'none';
                judgeView.style.display = 'block';
            } else {
                // Ø§Ù„Ø¨Ù‚ÙŠØ©: Ø¨Ø·Ø§Ù‚Ø© Ø³Ø±ÙŠØ©
                judgeView.style.display = 'none';
                cardContainer.style.display = 'block';
                instructions.style.display = 'block';
                setupCardColors(role);
            }
        }

        function setupCardColors(role) {
            const cardBack = document.getElementById('cardBack');
            const title = document.getElementById('roleTitle');
            const desc = document.getElementById('roleDesc');
            
            title.innerText = role;

            if (role === 'Ù…Ø§ÙÙŠØ§') {
                cardBack.style.backgroundColor = '#7f1d1d'; // Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙ‚Ø·
                cardBack.style.borderColor = '#dc2626';
                title.style.color = '#fca5a5';
                desc.innerText = "Ø§Ù‚ØªÙ„ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† ÙÙŠ Ø§Ù„Ù„ÙŠÙ„ØŒ ÙˆØ§ÙƒØ°Ø¨ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø±!";
            } else if (role === 'Ø¯ÙƒØªÙˆØ±') {
                cardBack.style.backgroundColor = '#14532d';
                cardBack.style.borderColor = '#10b981';
                title.style.color = '#86efac';
                desc.innerText = "Ø£Ù†Ù‚Ø° Ø´Ø®ØµØ§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ ÙƒÙ„ Ù„ÙŠÙ„Ø©.";
            } else if (role === 'Ù…Ø­Ù‚Ù‚') {
                cardBack.style.backgroundColor = '#1e3a8a';
                cardBack.style.borderColor = '#3b82f6';
                title.style.color = '#93c5fd';
                desc.innerText = "Ø§Ø³Ø£Ù„ Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ù‡ÙˆÙŠØ© Ø´Ø®Øµ ÙˆØ§Ø­Ø¯.";
            } else {
                cardBack.style.backgroundColor = '#374151';
                cardBack.style.borderColor = '#9ca3af';
                title.style.color = '#f3f4f6';
                desc.innerText = "Ù…ÙˆØ§Ø·Ù† Ø´Ø±ÙŠÙ. Ø±Ø§Ù‚Ø¨ØŒ ÙˆØµÙˆØª Ù„Ø·Ø±Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§.";
            }
        }

        const cardInner = document.getElementById('cardInner');
        const container = document.getElementById('cardContainer');
        const revealCard = (e) => { e.preventDefault(); cardInner.classList.add('flipped'); };
        const hideCard = (e) => { e.preventDefault(); cardInner.classList.remove('flipped'); };

        container.addEventListener('mousedown', revealCard);
        container.addEventListener('mouseup', hideCard);
        container.addEventListener('mouseleave', hideCard); 
        container.addEventListener('touchstart', revealCard, {passive: false});
        container.addEventListener('touchend', hideCard);
        container.addEventListener('touchcancel', hideCard);

    </script>
</head>
<body>
    
    <div id="setupScreen">
        <div class="header">
            <div style="color: #888;">Ø£Ø®Ø¨Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯</div>
            <div class="pin-display" id="pinDisplay">----</div>
        </div>

        <div class="panel">
            <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            <div class="setting-row">
                <span>Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù‚Ø§Ø¶ÙŠØŸ</span>
                <select id="judgeSelect"></select>
            </div>
            <div class="setting-row">
                <span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§:</span>
                <select id="mafiaCount">
                    <option value="1">1 Ù…Ø§ÙÙŠØ§</option>
                    <option value="2">2 Ù…Ø§ÙÙŠØ§</option>
                </select>
            </div>
        </div>

        <div class="panel">
            <h2>ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†Ø¶Ù…ÙŠÙ† (<span id="playerCount">0</span>)</h2>
            <div class="players-list" id="playersList"></div>
        </div>

        <button id="startBtn" class="btn-start" onclick="distributeRoles()">ğŸ² ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
    </div>

    <div id="gameScreen">
        <div class="judge-banner">âš–ï¸ Ø§Ù„Ù‚Ø§Ø¶ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©: <span id="judgeName"></span></div>
        
        <div class="instruction" id="instructionText">Ø§Ø¶ØºØ· Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ø±Ø¤ÙŠØ© Ø¯ÙˆØ±Ùƒ<br><span style="font-size: 0.8rem; color:#666;">Ø³ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ Ø¨Ù…Ø¬Ø±Ø¯ Ø±ÙØ¹ Ø¥ØµØ¨Ø¹Ùƒ</span></div>

        <div id="judgeView">
            <div class="judge-title">Ø£Ù†Øª Ø§Ù„Ù‚Ø§Ø¶ÙŠ âš–ï¸</div>
            <div class="judge-desc">Ù…Ù‡Ù…ØªÙƒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø§Ø´ØŒ ÙˆØªÙ†Ø¸ÙŠÙ… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØµÙˆÙŠØªØŒ ÙˆØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø§ÙÙŠØ§ ÙˆØ§Ù„Ù…Ø­Ù‚Ù‚ ÙˆØ§Ù„Ø¯ÙƒØªÙˆØ± ÙÙŠ Ø§Ù„Ù„ÙŠÙ„.</div>
        </div>

        <div class="card-container" id="cardContainer">
            <div class="card-inner" id="cardInner">
                <div class="card-front">ØŸ</div>
                <div class="card-back" id="cardBack">
                    <div style="font-size: 1.2rem; color: #ddd;">Ø£Ù†Øª:</div>
                    <div class="role-title" id="roleTitle">...</div>
                    <div class="role-desc" id="roleDesc">...</div>
                </div>
            </div>
        </div>

        <button class="btn-end" onclick="endRound()">ğŸ”„ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ¨ÙŠ</button>
    </div>

</body>
</html>
